//=====================================================================
//                    液晶显示模块 程序设计
//文件名：menu.c
//writer:谷雨 2008年8月25日于EDA实验室
//说明： 本程序中函数void show_SIN(void)比较乱，组织的不太好
//=====================================================================

#include <STC89C51RC.h>      //STC单片机头文件
#include "AD9854.h"  
#include "ocmj.h"
#include "key.h"

#define uint  unsigned int
#define uchar unsigned char

static void delay_1 (uint us); 
static void delay_1000 (uint us);

extern void show_FSK(void);
extern void show_RFSK(void);
extern void show_BPSK(void);
extern void show_OSK(void);	 
extern void show_AM(void);
extern void show_SIN(void);
static void SIN_IN(uchar key);

uchar code img[]={
/*--  宽度x高度=128x64  --*/
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x01,0x00,0x80,0x00,0x0F,0xFF,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x0C,0x43,0x01,0x80,0x00,0x7F,0xFF,0xF0,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x19,0xFF,0x07,0x00,0x07,0xFF,0xFF,0xFE,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x01,0x3F,0xFC,0x1E,0x00,0x1F,0xFF,0xFF,0xFF,0x80,0x00,0x00,0x00,
0x00,0x00,0x00,0x01,0xBF,0xFF,0xFC,0x00,0x7F,0xFC,0x00,0x7F,0xC0,0x00,0x00,0x00,
0x00,0x00,0x00,0x01,0xFF,0xFF,0xF0,0x00,0xFF,0xC0,0x00,0x0F,0xE0,0x00,0x00,0x00,
0x00,0x00,0x00,0x01,0xFF,0xFF,0xE0,0x03,0xFF,0xFF,0xFC,0x01,0xF0,0x00,0x00,0x00,
0x00,0x00,0x00,0x01,0xDF,0xFF,0xC0,0x07,0xFF,0xFF,0xFF,0x80,0xF0,0x00,0x00,0x00,
0x00,0x00,0x00,0x03,0xFF,0xFF,0x00,0x0F,0xFF,0xFF,0xFF,0xE0,0x38,0x00,0x00,0x00,
0x00,0x00,0x00,0x07,0xFF,0xF8,0x00,0x1F,0xFF,0xF0,0x03,0xF8,0x38,0x00,0x00,0x00,
0x00,0x00,0x00,0x07,0xFF,0xE0,0x00,0x3F,0xFF,0xFF,0xC0,0x7C,0x18,0x00,0x00,0x00,
0x00,0x00,0x00,0x04,0x7F,0xF0,0x00,0x3F,0xFF,0xFF,0xF8,0x1E,0x08,0x00,0x00,0x00,
0x00,0x00,0x00,0x01,0xFF,0xF8,0x00,0x7F,0xFF,0xFF,0xFE,0x0F,0x08,0x00,0x00,0x00,
0x00,0x00,0x00,0x0F,0xFF,0xFC,0x00,0xFF,0xFF,0xFF,0xFF,0x87,0x08,0x00,0x00,0x00,
0x00,0x00,0x00,0x1F,0xFF,0xFE,0x00,0xFF,0xFF,0xFF,0xFF,0x83,0x88,0x00,0x00,0x00,
0x00,0x00,0x00,0x3F,0xFF,0xFE,0x01,0xFF,0xFF,0xFF,0xFF,0xC3,0x88,0x00,0x00,0x00,
0x00,0x00,0x00,0x7F,0xFF,0xFE,0x01,0xFF,0xFF,0xFF,0xFF,0xE1,0x88,0x00,0x00,0x00,
0x00,0x00,0x00,0xFF,0xFF,0xFE,0x03,0xFF,0xFF,0xFF,0xFF,0xE1,0x88,0x00,0x00,0x00,
0x00,0x00,0x01,0xFF,0xFF,0xFE,0x03,0xFF,0xFF,0xFF,0xFF,0xF1,0x88,0x00,0x00,0x00,
0x00,0x00,0x01,0xFF,0xFF,0xFE,0x03,0xFF,0xFF,0xFF,0xFF,0xF3,0x08,0x00,0x00,0x00,
0x00,0x00,0x01,0xFF,0xFF,0xFF,0x07,0xFF,0xFF,0xFF,0xFF,0xF2,0x10,0x00,0x00,0x00,
0x00,0x00,0x01,0xFF,0xFF,0xFF,0x8F,0xFF,0xFF,0xFF,0xFF,0xF0,0x20,0x00,0x00,0x00,
0x00,0x00,0x01,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xF0,0x00,0x00,0x00,0x00,
0x00,0x00,0x01,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x70,0x00,0x00,0x00,0x00,
0x00,0x00,0x01,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFE,0xFF,0x70,0x00,0x00,0x00,0x00,
0x00,0x00,0x01,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFE,0xFF,0x70,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0xFF,0xFF,0xFF,0xFF,0xFF,0x7F,0xFF,0x7F,0x20,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0xFF,0xFF,0xFF,0xFF,0xFF,0xBF,0xFF,0x7F,0x20,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x7F,0xFF,0xFF,0xFF,0xFF,0xDF,0xFF,0x7E,0x20,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x3F,0xFF,0xFF,0xFF,0xFF,0xDF,0xFF,0x3E,0x40,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x1F,0xFF,0xFF,0xFF,0xFF,0xCF,0xFF,0x3C,0x40,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x0F,0xFF,0xFF,0xFF,0xFF,0xCF,0xFE,0x38,0x40,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x07,0xFF,0xFF,0xFF,0xFF,0x8F,0xFE,0x38,0x40,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x01,0xFF,0xFF,0xFF,0xFF,0x8F,0xFE,0x30,0x40,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0xFF,0xFF,0xFF,0xFF,0x1F,0x7C,0x20,0x40,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x7F,0xFF,0xFF,0xFE,0x1E,0x78,0x00,0x40,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x3F,0xFF,0xFF,0xFE,0x1E,0xF0,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x1F,0xFF,0xFF,0xDA,0x3C,0xE0,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x07,0xFF,0xFF,0xF2,0x30,0x80,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x01,0xFF,0xFF,0xF1,0x20,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0xFE,0x7F,0xF0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x7C,0x3F,0xF0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x78,0x1F,0xE0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x72,0x07,0xE0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x70,0x00,0xE0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x60,0x00,0x78,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x60,0x00,0x60,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0xC0,0x03,0xF0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x01,0x40,0x04,0xD8,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x01,0x00,0x01,0x08,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x02,0x0C,0x02,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x02,0x40,0x04,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x0C,0x48,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x38,0x41,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x0F,0xE2,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x40,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
};

//================================================================= 
// 函数名称 ：void delay (uint us)
// 函数功能 ：小延时
// 入口参数 ：us  延时时间的长短
// 出口参数 ：无
//=================================================================
void delay_1 (uint us)   
{
  while(us--);
}  

//================================================================= 
// 函数名称 ：void delay_1000 (uint us)
// 函数功能 ：大延时
// 入口参数 ：us  延时时间的长短
// 出口参数 ：无
//=================================================================
void delay_1000 (uint us)   
{
  while(us--)
  {
  	  delay_1(1000);
  }
} 

//================================================================= 
// 函数名称 ：void show_kaiji(void)
// 函数功能 ：显示开机界面
// 入口参数 ：无
// 出口参数 ：无
//=================================================================
void show_kaiji(void)   
{
	lat_disp (0xcc,0xcc);     //显示点阵
    delay_1000(300);

	clear();
	lat_disp (0xff,0x00);    //显示点阵
	delay_1000(300);

	clear();
	send_img(img);         //显示图像
	delay_1000(300);

	clear();   
	set_position(0,0);
	send_str("基于DDS 内核的");
	set_position(1,0);
	send_str("多功能高频实验仪");
	set_position(2,0);
	send_str("作者: 王波涛");
	set_position(3,0);	
	send_str("学院：光电学院");
	delay_1000(1000);				
}

//================================================================= 
// 函数名称 ：void show_select(void)
// 函数功能 ：显示输入功能界面
// 入口参数 ：无
// 出口参数 ：无
//=================================================================
void show_select(void)
{
    clear();

	set_position(0,0);
	send_str("  请选择功能键");
	set_position(1,0);
	send_str("  SIN     FSK");
	set_position(2,0);
	send_str("  RFSK    BPSK");
	set_position(3,0);
	send_str("  OSK     AM");
}

//================================================================= 
// 函数名称 ：void show_error(void)
// 函数功能 ：输入错误提示
// 入口参数 ：无
// 出口参数 ：无
//=================================================================
void show_error(void)
{
	uchar i;
	for(i=0;i<3;i++)
	{
		clear();
		delay_1000(45);
		set_position(1,0);
		send_str("  您的输入错误");
		set_position(2,0);
		send_str("  请您重新输入");
		delay_1000(45);
	}
	show_select();	
}

//================================================================= 
// 函数名称 ：void show_FSK(void)
// 函数功能 ：FSK操作界面
// 入口参数 ：无
// 出口参数 ：无
//=================================================================
void show_FSK(void)
{
	uchar key,i;
	
	uchar code tab[]={0xd5,0xfd};   //“正”字显示不出来，用内码显示

	clear();

	set_position(1,0);
	send_str("您选择了FSK 功能");
	set_position(2,1);
	send_str("请确定或退出");
	
	key=0xff;	

	while(key==0xff)        //等待有键按下
	{
		key=Key_Get();
	}

	if(key==15)				 //按下确定键
	{	
		AD9854_InitFSK();
		AD9854_SetFSK(1000,100000);	 //FSK低频和高频分别为1K和100K

		clear();
		set_position(1,0);
		send_chin(tab);
		set_position(1,1);
		send_str("在进行FSK 操作");
		set_position(2,0);
		send_str("请按任意键返回");

		while(Key_Get()==0xff)
		{
			AD9854_FDATA = 1;
			delay_1000(10);	      //延时时间长，便于观察
			AD9854_FDATA = 0;
			delay_1000(9);
		}

		AD9854_Init();			  //AD9854初始化，以关闭FSK

		show_select();			  //显示选择功能界面
	}
	else if(key==14)
	{
		for(i=0;i<3;i++)
		{
			clear();
			delay_1000(45);
			set_position(1,1);
			send_str("您选择了退出");
			delay_1000(45);
		}
		show_select();			  //显示选择功能界面
	}
	else
	{
		show_error();			 //错误提示
		show_FSK();             
	}			
}

//================================================================= 
// 函数名称 ：void show_RFSK(void)
// 函数功能 ：FSK操作界面
// 入口参数 ：无
// 出口参数 ：无
//=================================================================
void show_RFSK(void)
{
	uchar key,i;
	
	uchar code tab[]={0xd5,0xfd};   //“正”字显示不出来，用内码显示

	clear();

	set_position(1,0);
	send_str("您选择了RFSK功能");
	set_position(2,1);
	send_str("请确定或退出");
	
	key=0xff;	

	while(key==0xff)                 //等待有键按下
	{
		key=Key_Get();
	}

	if(key==15)				          //按下确定键
	{	
		AD9854_InitRFSK();
		AD9854_SetRFSK(1000,100000,50,20);	 

		clear();
		set_position(1,0);
		send_chin(tab);
		set_position(1,1);
		send_str("在进行RFSK操作");
		set_position(2,0);
		send_str("请按任意键返回");

		while(Key_Get()==0xff)
		{
			AD9854_FDATA = 1;
			delay_1000(10);	      //延时时间长，便于观察
			AD9854_FDATA = 0;
			delay_1000(9);
		}

		AD9854_Init();			  //AD9854初始化，以关闭RFSK

		show_select();			  //显示选择功能界面
	}
	else if(key==14)
	{
		for(i=0;i<3;i++)
		{
			clear();
			delay_1000(45);
			set_position(1,1);
			send_str("您选择了退出");
			delay_1000(45);
		}
		show_select();			  //显示选择功能界面
	}
	else
	{
		show_error();			 //错误提示
		show_RFSK();             
	}		
}

//================================================================= 
// 函数名称 ：void show_BPSK(void)
// 函数功能 ：BPSK操作界面
// 入口参数 ：无
// 出口参数 ：无
//=================================================================
void show_BPSK(void)
{
	uchar key,i;
	
	uchar code tab[]={0xd5,0xfd};   //“正”字显示不出来，用内码显示

	clear();

	set_position(1,0);
	send_str("您选择了BPSK功能");
	set_position(2,1);
	send_str("请确定或退出");
	
	key=0xff;	

	while(key==0xff)                 //等待有键按下
	{
		key=Key_Get();
	}

	if(key==15)				          //按下确定键
	{	
		AD9854_InitBPSK();
		AD9854_SetBPSK(0,8192);	 //设置相位

		clear();
		set_position(1,0);
		send_chin(tab);
		set_position(1,1);
		send_str("在进行BPSK操作");
		set_position(2,0);
		send_str("请按任意键返回");

		while(Key_Get()==0xff)
		{
			AD9854_FDATA = 1;
			delay_1(20);	      //延时时间长，便于观察
			AD9854_FDATA = 0;
			delay_1(5);
		}

		AD9854_Init();			  //AD9854初始化，以关闭BPSK

		show_select();			  //显示选择功能界面
	}
	else if(key==14)
	{
		for(i=0;i<3;i++)
		{
			clear();
			delay_1000(45);
			set_position(1,1);
			send_str("您选择了退出");
			delay_1000(45);
		}
		show_select();			  //显示选择功能界面
	}
	else
	{
		show_error();			 //错误提示
		show_BPSK();             
	}		
}

//================================================================= 
// 函数名称 ：void show_OSK(void);
// 函数功能 ：OSK操作界面
// 入口参数 ：无
// 出口参数 ：无
//=================================================================
void show_OSK(void)
{
	uchar key,i;
	
	uchar code tab[]={0xd5,0xfd};   //“正”字显示不出来，用内码显示

	clear();

	set_position(1,0);
	send_str("您选择了OSK 功能");
	set_position(2,1);
	send_str("请确定或退出");
	
	key=0xff;	

	while(key==0xff)                 //等待有键按下
	{
		key=Key_Get();
	}

	if(key==15)				          //按下确定键
	{	
		AD9854_InitOSK();
		AD9854_SetOSK(10);	 //设置斜率

		clear();
		set_position(1,0);
		send_chin(tab);
		set_position(1,1);
		send_str("在进行OSK 操作");
		set_position(2,0);
		send_str("请按任意键返回");

		while(Key_Get()==0xff)
		{
			AD9854_OSK=1;	
			delay_1(30); 
			AD9854_OSK=0;	
			delay_1(30);
		}

		AD9854_Init();			  //AD9854初始化，以关闭OSK

		show_select();			  //显示选择功能界面
	}
	else if(key==14)
	{
		for(i=0;i<3;i++)
		{
			clear();
			delay_1000(45);
			set_position(1,1);
			send_str("您选择了退出");
			delay_1000(45);
		}
		show_select();			  //显示选择功能界面
	}
	else
	{
		show_error();			 //错误提示
		show_OSK();             
	}				
}

//================================================================= 
// 函数名称 ：void show_AM(void);
// 函数功能 ：OSK操作界面
// 入口参数 ：无
// 出口参数 ：无
//=================================================================
void show_AM(void)
{
	uchar key;
	uchar i;
	
	uchar code tab[]={0xd5,0xfd};   //“正”字显示不出来，用内码显示

	clear();

	set_position(1,0);
	send_str("您选择了AM功能");
	set_position(2,1);
	send_str("请确定或退出");
	
	key=0xff;	

	while(key==0xff)                 //等待有键按下
	{
		key=Key_Get();
	}

	if(key==15)				          //按下确定键
	{	
		AD9854_InitAM();

		clear();
		set_position(1,0);
		send_chin(tab);
		set_position(1,1);
		send_str("在进行AM操作");
		set_position(2,0);
		send_str("请按任意键返回");

		while(Key_Get()==0xff)
		{
			AD9854_SetAM(2000);
			delay_1(10);	      
			AD9854_SetAM(4000);
			delay_1(10);
		}

		AD9854_Init();			  //AD9854初始化，以关闭AM

		show_select();			  //显示选择功能界面
	}
	else if(key==14)
	{
		for(i=0;i<3;i++)
		{
			clear();
			delay_1000(45);
			set_position(1,1);
			send_str("您选择了退出");
			delay_1000(45);
		}
		show_select();			  //显示选择功能界面
	}
	else
	{
		show_error();			 //错误提示
		show_AM();             
	}		
}

//================================================================= 
// 函数名称 ：void show_SIN(void)
// 函数功能 ：正弦波产生操作界面
// 入口参数 ：无
// 出口参数 ：无
//=================================================================
void show_SIN(void)
{
	uchar code tab[]={0xd5,0xfd};       //“请输入正弦波频率”的“正”字显示不出来，用内码显示
	uchar key;
	uint i;

	clear();

	set_position(0,0);
	send_str("您选择了SIN 功能");
	set_position(1,0);
	send_str("请输入");
	set_position(1,3);
	send_str(tab); 
	set_position(1,4);
	send_str("弦波频率"); 
	set_position(2,0); 
	send_str("  频率输入范围: "); 
	set_position(3,0); 
	send_str("     0~50MHZ    "); 	

	key=0xff;	

	while(key==0xff)                 //等待有键按下
	{
		key=Key_Get();
	}


	if((key>=1)&&(key<=9))		   //第一次按键处理
	{
		SIN_IN(key);	
	}
	else if(key==14)
	{
		for(i=0;i<3;i++)
		{
			clear();
			delay_1000(45);
			set_position(1,1);
			send_str("您选择了退出");
			delay_1000(45);
		}
		show_select();			  //显示选择功能界面
	}
	else
	{
		show_error();			 //错误提示
		show_SIN(); 
	}
}

//================================================================= 
// 函数名称 ：void SIN_IN(uchar key)
// 函数功能 ：正弦波输入参数处理
// 入口参数 ：key  上次按键的键值
// 出口参数 ：无
//=================================================================
void SIN_IN(uchar key)
{
	bit ERROR=0;	                    //错误标志位
	bit IN_OVRE=0;						//输入完毕标志
	bit Clear=0;						//清零标志
	ulong freq;                         //长整形频率
	uchar key_buf[8];					//输入参数保存数组
	uchar num; 							//输入参数计数变量
	uchar freq_unit;				    //频率单位变量
	bit Flag=0;							//输入正确标志
    uchar i;

	key_buf[0]=key;					     //将按键存入数组
	num=1;								 //数组内标为1

	clear();                   //清屏
		
	set_position(0,0);
	send_str("您输入的频率为:");
	set_position(1,0);
	send_char(key+48);

	while(1)
	{
		key=0xff;	

		while(key==0xff)                 //等待有键按下
		{
			key=Key_Get();
		}

		switch(key)
		{
			case 0:
			case 1:
			case 2:
			case 3:
			case 4:
			case 5:
			case 6:
			case 7:
			case 8:
			case 9:
				send_char(key+48); 
				if(num<8)
				{
					key_buf[num]=key;					     //将按键存入数组
					num++;
				}
				else
				{
					for(i=0;i<3;i++)
					{
						clear();
						delay_1000(45);
						set_position(1,1);
						send_str("您的输入溢出");
						set_position(2,1);
						send_str("请您重新输入");
						delay_1000(45);
					}
					Clear=1;                   //清零标志置位
				}             
				break;	
			case 10:
				send_char('H');
				send_char('Z');
				freq_unit=1;		   //频率单位变量置为1
				IN_OVRE=1;		      //输入完毕
				break;
			case 11:
				send_char('K');
				send_char('H');
				send_char('Z');
				freq_unit=2;		   //频率单位变量置为2
				IN_OVRE=1;		      //输入完毕
				break;
			case 12:
				send_char('M');
				send_char('H');
				send_char('Z');
				freq_unit=3;		   //频率单位变量置为3
				IN_OVRE=1;		      //输入完毕
				break;
			case 13:
				for(i=0;i<3;i++)
				{
					clear();
					delay_1000(45);
					set_position(1,1);
					send_str("您选择了清零");
					set_position(2,1);
					send_str("请您重新输入");
					delay_1000(45);
				}
				Clear=1;                   
				break;
			case 14:
				for(i=0;i<3;i++)
				{
					clear();
					delay_1000(45);
					set_position(1,1);
					send_str("您选择了退出");
					delay_1000(45);
				}
				ERROR=1;		 
				break;
			case 15:
				show_error();
				ERROR=1;
				break;
		}

		if((ERROR==1)||(IN_OVRE==1)||(Clear==1))
		{
			break;                  //错误，退出循环
		}
	}

	if(IN_OVRE==1)		             //输入完毕，等待确认
	{
		freq=0;

		for(i=0;i<num;i++)			  //计算输入频率
		{	
			freq = freq*10+key_buf[i];
		}

		switch(freq_unit)             //单位处理
		{
			case 1:
				if(freq<=50000000)
				{
					Flag=1;           //输入正确标志置1
				}
				else
				{
					Flag=0;           //输入正确标志置0
				}
				break;
			case 2:
				if(freq<=50000)
				{
					Flag=1;           //输入正确标志置1
					freq*=1000;
				}
				else
				{
					Flag=0;           //输入正确标志置0
				}
				break;
			case 3:
				if(freq<=50)
				{
					Flag=1;           //输入正确标志置1
					freq*=1000000;
				}
				else
				{
					Flag=0;           //输入正确标志置0
				}
				break;
			default:
				break;
		}

		if(Flag==1)
		{
			set_position(2,1);
			send_str("您已输入频率");
			set_position(3,1);
			send_str("请确定或清零");

			key=0xff;	

			while(key==0xff)                 //等待有键按下
			{
				key=Key_Get();
			}

	loop:	if(key==15)				          //按下确定键
			{
				AD9854_Init();
				AD9854_SetSine(freq,4000);	 
	
				clear_line(0);	                //清除第一行
				clear_line(2);	                //清除第二行
				clear_line(3);	                //清除第三行
	
				set_position(0,0);
				send_str("已经产生频率为");
				set_position(1,5);
				send_str("的波形");
	
				set_position(2,0);
				send_str("请按任意键返回");
	
				while(Key_Get()==0xff);        //等待按键
	
				AD9854_Init();			      //AD9854初始化，以关闭波形产生
	
				show_select();			     //显示选择功能界面
			}
			else if(key==13)				//清零处理
			{
				for(i=0;i<3;i++)
				{
					clear();
					delay_1000(45);
					set_position(1,1);
					send_str("您选择了清零");
					set_position(2,1);
					send_str("请您重新输入");
					delay_1000(45);
				}
				Clear=1;	
			}
			else if(key==14)
			{
				for(i=0;i<3;i++)
				{
					clear();
					delay_1000(45);
					set_position(1,1);
					send_str("您选择了退出");
					delay_1000(45);
				}
				Clear=1;
			}
			else				
			{
				while(key<13)
				{
					for(i=0;i<3;i++)
					{
						clear_line(2);
						clear_line(3);
						delay_1000(45);
						set_position(2,1);
						send_str("您的输入错误");
						set_position(3,1);
						send_str("请您重新输入");
						delay_1000(45);
					}
	
					clear_line(2);
					clear_line(3);
					set_position(2,1);
					send_str("您已输入频率");
					set_position(3,1);
					send_str("请确定或清零");

					key=0xff;	

					while(key==0xff)                 //等待有键按下
					{
						key=Key_Get();
					}
				}

				goto loop;				 //程序没有办法调了，来了个goto
			}	
		}
		else
		{
			delay_1000(120);

			for(i=0;i<3;i++)
			{
				clear();
				delay_1000(45);
				set_position(1,1);
				send_str("您的输入溢出");
				set_position(2,1);
				send_str("请您重新输入");
				delay_1000(45);

				Clear=1;                   //清零标志置位
			}
		}			
	}
	if((Clear==1)||(ERROR==1))			   //错误、退出和清零处理
	{
		show_SIN();
	}	
}
